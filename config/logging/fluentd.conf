# Fluentd configuration for Docker log aggregation
#
# This configuration collects logs from Docker containers and forwards them
# to a centralized logging system (Elasticsearch, Loki, etc.)
#
# Usage:
#   docker-compose -f docker-compose.logging.yml up -d

<source>
  @type tail
  @id container_logs
  path /var/lib/docker/containers/*/*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag docker.*
  read_from_head true
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

# Filter out health check noise
<filter docker.**>
  @type grep
  <exclude>
    key message
    pattern /^GET \/api\/health/
  </exclude>
</filter>

# Add Kubernetes/Docker metadata
<filter docker.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    environment "#{ENV['ENVIRONMENT'] || 'production'}"
  </record>
</filter>

# Output to Elasticsearch (configure as needed)
# <match docker.**>
#   @type elasticsearch
#   host elasticsearch
#   port 9200
#   logstash_format true
#   logstash_prefix fluentd
#   <buffer>
#     @type file
#     path /var/log/fluentd-es-buffer
#     flush_mode interval
#     flush_interval 10s
#   </buffer>
# </match>

# Output to Loki (configure as needed)
# <match docker.**>
#   @type loki
#   url http://loki:3100
#   <label>
#     service ${record["service"]}
#     level ${record["level"]}
#   </label>
#   <buffer>
#     @type file
#     path /var/log/fluentd-loki-buffer
#     flush_mode interval
#     flush_interval 10s
#   </buffer>
# </match>

# Fallback: stdout for debugging
<match docker.**>
  @type stdout
</match>
