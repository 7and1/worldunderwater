# Production Docker Compose for VPS (107.174.42.198)
# Uses existing Supabase DB - DO NOT run separate DB container
# Port: 3024 (web), 3025 (cms/admin)

services:
  web:
    build: .
    container_name: worldunderwater-web
    restart: unless-stopped
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
      PORT: 3000
    ports:
      - "3024:3000"
    volumes:
      - ./public/generated:/app/public/generated
    networks:
      - supabase-tier
      - proxy-tier
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cms:
    build: .
    container_name: worldunderwater-cms
    restart: unless-stopped
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
      PORT: 3001
    ports:
      - "3025:3001"
    command: ["npm", "run", "payload"]
    volumes:
      - ./public/generated:/app/public/generated
    networks:
      - supabase-tier
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3001/admin",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  supabase-tier:
    external: true
    name: supabase_default
  proxy-tier:
    external: true
    name: nginx-proxy_default
